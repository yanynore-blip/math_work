<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ ‚Äî Teacher</title>
<style>
  body{font-family:system-ui,Arial;margin:20px;max-width:920px}
  h1{margin-bottom:6px}
  label{display:block;margin-top:12px;font-weight:600}
  input[type=text], textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;font-size:15px}
  .questions {margin-top:10px}
  .question-row{display:flex;gap:8px;margin-top:8px}
  .question-row input{flex:1;padding:8px}
  .question-row button{padding:6px 8px}
  .controls{margin-top:14px}
  button{background:#2d8cff;color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .btn-ghost{background:#eee;color:#333;border:0}
  #preview img{max-width:100%;border-radius:6px;border:1px solid #eaeaea}
  .small{font-size:13px;color:#666}
  .link-out{margin-top:12px;padding:10px;background:#f6f8ff;border-radius:8px}
</style>
</head>
<body>
<h1>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h1>

<label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
  <input id="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Äî —Ç–µ—Å—Ç 1">
</label>

<label>–ó–∞–≥—Ä—É–∑–∏—Ç—å PNG (–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞)
  <input id="imageInput" type="file" accept="image/png,image/*">
</label>
<div id="preview" style="margin-top:8px"></div>

<div class="questions">
  <label>–í–æ–ø—Ä–æ—Å—ã (–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü, –∏—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å)</label>
  <div id="questionsList"></div>
  <div style="margin-top:8px">
    <button id="addQ" class="btn-ghost">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
  </div>
</div>

<div class="controls">
  <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <span class="small">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è assignmentId –∏ —Å—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞.</span>
</div>

<div id="result" class="link-out"></div>

<script>
const imageInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");
const questionsList = document.getElementById("questionsList");
const addQ = document.getElementById("addQ");
const saveBtn = document.getElementById("saveBtn");
const result = document.getElementById("result");
const titleEl = document.getElementById("title");

let currentImageDataUrl = "";

function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

addQ.addEventListener("click", ()=> addQuestion(""));

function addQuestion(text){
  const div = document.createElement("div");
  div.className = "question-row";
  div.innerHTML = `<input class="qtext" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..." value="${escapeHtml(text)}">
                   <button class="del">–£–¥–∞–ª–∏—Ç—å</button>`;
  questionsList.appendChild(div);
  div.querySelector(".del").addEventListener("click", ()=>div.remove());
}

// drag & drop preview
preview.addEventListener('dragover', e=>{ e.preventDefault(); preview.style.opacity=0.8; });
preview.addEventListener('dragleave', e=>{ preview.style.opacity=1; });
preview.addEventListener('drop', e=> {
  e.preventDefault();
  preview.style.opacity=1;
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});

imageInput.addEventListener("change", ev => {
  const file = ev.target.files[0];
  if (file) handleFile(file);
});

function handleFile(file){
  if (!file.type.startsWith("image/")) { alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"); return; }
  const reader = new FileReader();
  reader.onload = evt => {
    currentImageDataUrl = evt.target.result;
    preview.innerHTML = `<img src="${currentImageDataUrl}" alt="preview">`;
  };
  reader.readAsDataURL(file);
}

saveBtn.addEventListener("click", ()=> {
  result.innerHTML = "";
  const title = titleEl.value.trim() || ("–ó–∞–¥–∞–Ω–∏–µ " + new Date().toLocaleString());
  const qEls = Array.from(document.querySelectorAll(".qtext"));
  const questions = qEls.map(i=>i.value.trim()).filter(x=>x!=="");
  if (!currentImageDataUrl) { result.innerHTML = '<div style="color:red">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ PNG.</div>'; return; }
  if (questions.length === 0) { if(!confirm("–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤?")) return; }

  saveBtn.disabled = true;
  saveBtn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

  // üîπ –ò—Å–ø–æ–ª—å–∑—É–µ–º google.script.run –≤–º–µ—Å—Ç–æ fetch
  google.script.run
    .withSuccessHandler(data => {
      if (data.status === "ok") {
        result.innerHTML = `<div style="color:green">–ì–æ—Ç–æ–≤–æ. assignmentId: <b>${data.assignmentId}</b></div>`;
      } else {
        result.innerHTML = `<div style="color:red">–û—à–∏–±–∫–∞: ${data.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</div>`;
      }
      saveBtn.disabled = false;
      saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å";
    })
    .withFailureHandler(err => {
      result.innerHTML = `<div style="color:red">–û—à–∏–±–∫–∞: ${err.message}</div>`;
      saveBtn.disabled = false;
      saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å";
    })
    .createAssignment({ title, questions, imageDataUrl: currentImageDataUrl });
});

// –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –≤–æ–ø—Ä–æ—Å–æ–≤
for (let i=0;i<5;i++) addQuestion("");
</script>
</body>
</html>
